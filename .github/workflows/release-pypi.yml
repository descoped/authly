name: Release to PyPI

on:
  release:
    types: [published]

env:
  PYTHON_VERSION: '3.11'

jobs:
  validate-release:
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.extract-version.outputs.version }}
      
    steps:
    - name: Checkout code
      uses: actions/checkout@v5

    - name: Validate tag format
      run: |
        if [[ ! "${{ github.ref_name }}" =~ ^v[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
          echo "âŒ Invalid tag format: ${{ github.ref_name }}"
          echo "Expected format: v[0-9]+.[0-9]+.[0-9]+ (e.g., v1.2.3)"
          exit 1
        fi
        echo "âœ… Tag format is valid: ${{ github.ref_name }}"

    - name: Extract version
      id: extract-version
      run: |
        VERSION="${{ github.ref_name }}"
        VERSION="${VERSION#v}"  # Remove 'v' prefix
        echo "version=$VERSION" >> $GITHUB_OUTPUT
        echo "ðŸ“¦ Extracted version: $VERSION"

    - name: Set up Python
      uses: actions/setup-python@v6
      with:
        python-version: ${{ env.PYTHON_VERSION }}

    - name: Install uv
      uses: astral-sh/setup-uv@v7

    - name: Verify version consistency
      run: |
        PYPROJECT_VERSION=$(uv run python -c "import tomllib; print(tomllib.load(open('pyproject.toml', 'rb'))['project']['version'])")
        TAG_VERSION="${{ steps.extract-version.outputs.version }}"
        
        if [[ "$PYPROJECT_VERSION" != "$TAG_VERSION" ]]; then
          echo "âŒ Version mismatch!"
          echo "   pyproject.toml version: $PYPROJECT_VERSION"
          echo "   Git tag version: $TAG_VERSION"
          echo ""
          echo "Please update pyproject.toml version to match the git tag"
          exit 1
        fi
        
        echo "âœ… Version consistency verified: $TAG_VERSION"

  lint-and-test:
    runs-on: ubuntu-latest
    needs: validate-release
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v5

    - name: Set up Python
      uses: actions/setup-python@v6
      with:
        python-version: ${{ env.PYTHON_VERSION }}

    - name: Install uv
      uses: astral-sh/setup-uv@v7

    - name: Install dependencies
      run: |
        uv sync --all-groups

    - name: Run linting
      run: |
        echo "ðŸ” Running code linting..."
        uv run ruff check .
        uv run ruff format --check .
        echo "âœ… Linting passed"

    - name: Run tests with coverage
      env:
        # Resource Manager Configuration
        AUTHLY_MODE: testing
        AUTHLY_BOOTSTRAP_ENABLED: true
        
        # Database (uses testcontainers)
        DATABASE_URL: postgresql://test:test@localhost:5432/test
        
        # JWT Configuration
        JWT_SECRET_KEY: test-secret-key-for-ci-only-256-bit-long
        JWT_REFRESH_SECRET_KEY: test-refresh-secret-key-for-ci-only-256-bit-long
        
        # Admin Configuration
        AUTHLY_ADMIN_USERNAME: admin
        AUTHLY_ADMIN_PASSWORD: admin123
        AUTHLY_ADMIN_EMAIL: admin@localhost
        AUTHLY_ADMIN_ALLOW_LOCALHOST: true
        AUTHLY_ADMIN_API_ENABLED: true
        
        # Testing port range
        FASTAPI_TESTING_PORT_RANGE_START: 8001
        FASTAPI_TESTING_PORT_RANGE_END: 9000
      run: |
        echo "ðŸ§ª Running test suite with coverage..."
        uv run pytest -v --tb=short --cov=src/authly --cov-report=xml --cov-report=term
        echo "âœ… All tests passed"

    - name: Upload coverage reports to Codecov
      uses: codecov/codecov-action@v5
      with:
        token: ${{ secrets.CODECOV_TOKEN }}
        slug: descoped/authly

  build-and-publish-to-pypi:
    runs-on: ubuntu-latest
    needs: [validate-release, lint-and-test]
    environment: pypi
    permissions:
      id-token: write  # For trusted publishing
      contents: read
      attestations: write  # For artifact attestation
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v5

    - name: Set up Python
      uses: actions/setup-python@v6
      with:
        python-version: ${{ env.PYTHON_VERSION }}

    - name: Install uv
      uses: astral-sh/setup-uv@v7

    - name: Build package
      run: |
        echo "ðŸ”¨ Building package for version ${{ needs.validate-release.outputs.version }}"
        uv build
        echo "ðŸ“‹ Built artifacts:"
        ls -la dist/
        echo "âœ… Package build completed"

    - name: Generate artifact attestation
      uses: actions/attest-build-provenance@v3
      with:
        subject-path: 'dist/*'

    - name: Upload wheel as artifact
      uses: actions/upload-artifact@v5
      with:
        name: python-package
        path: dist/*.whl
        retention-days: 1

    - name: Publish to PyPI
      env:
        PYPI_API_TOKEN: ${{ secrets.PYPI_API_TOKEN }}
      run: |
        echo "ðŸš€ Publishing to PyPI..."
        uv publish --token $PYPI_API_TOKEN
        echo "âœ… Successfully published authly v${{ needs.validate-release.outputs.version }} to PyPI"

    - name: Create deployment summary
      run: |
        echo "## ðŸŽ‰ Release Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "- **Package**: authly" >> $GITHUB_STEP_SUMMARY
        echo "- **Version**: ${{ needs.validate-release.outputs.version }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Git Tag**: ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
        echo "- **PyPI URL**: https://pypi.org/project/authly/${{ needs.validate-release.outputs.version }}/" >> $GITHUB_STEP_SUMMARY
        echo "- **Docker Images**: [descoped/authly](https://hub.docker.com/r/descoped/authly), [descoped/authly-standalone](https://hub.docker.com/r/descoped/authly-standalone)" >> $GITHUB_STEP_SUMMARY
        echo "- **Documentation**: [Docker Deployment Guide](https://github.com/descoped/authly/blob/master/docs/docker-deployment.md)" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### Installation" >> $GITHUB_STEP_SUMMARY
        echo '```bash' >> $GITHUB_STEP_SUMMARY
        echo "# Install as library" >> $GITHUB_STEP_SUMMARY
        echo "uv add authly==${{ needs.validate-release.outputs.version }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "# Install as CLI tool" >> $GITHUB_STEP_SUMMARY
        echo "uvx install authly==${{ needs.validate-release.outputs.version }}" >> $GITHUB_STEP_SUMMARY
        echo "authly --help" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "# Run standalone all-in-one container (includes PostgreSQL + Redis)" >> $GITHUB_STEP_SUMMARY
        echo "docker run -it --rm -p 8000:8000 descoped/authly-standalone:${{ needs.validate-release.outputs.version }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "# Latest standalone image" >> $GITHUB_STEP_SUMMARY
        echo "docker run -it --rm -p 8000:8000 descoped/authly-standalone:latest" >> $GITHUB_STEP_SUMMARY
        echo '```' >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### CLI Usage" >> $GITHUB_STEP_SUMMARY
        echo '```bash' >> $GITHUB_STEP_SUMMARY
        echo "# Start OAuth server" >> $GITHUB_STEP_SUMMARY
        echo "authly serve --host 0.0.0.0 --port 8000" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "# Development mode with embedded PostgreSQL" >> $GITHUB_STEP_SUMMARY
        echo "authly serve --embedded --seed" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "# Admin operations" >> $GITHUB_STEP_SUMMARY
        echo "authly admin login -u admin" >> $GITHUB_STEP_SUMMARY
        echo "authly admin client create --name MyApp --client-type public --redirect-uri http://localhost:3000/callback" >> $GITHUB_STEP_SUMMARY
        echo '```' >> $GITHUB_STEP_SUMMARY

  docker-build-production:
    runs-on: ubuntu-latest
    needs: [validate-release, lint-and-test, build-and-publish-to-pypi]
    permissions:
      contents: read
      packages: write  # For Docker registry push
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v5

    - name: Download wheel artifact
      uses: actions/download-artifact@v6
      with:
        name: python-package
        path: dist/

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Log in to Docker Hub
      uses: docker/login-action@v3
      with:
        username: ${{ secrets.DOCKERHUB_USERNAME }}
        password: ${{ secrets.DOCKERHUB_TOKEN }}

    - name: Extract metadata
      id: meta
      uses: docker/metadata-action@v5
      with:
        images: |
          descoped/authly
        tags: |
          type=semver,pattern={{version}},value=${{ needs.validate-release.outputs.version }}
          type=semver,pattern={{major}}.{{minor}},value=${{ needs.validate-release.outputs.version }}
          type=semver,pattern={{major}},value=${{ needs.validate-release.outputs.version }}
          type=raw,value=latest

    - name: Build and push production Docker image
      uses: docker/build-push-action@v6
      with:
        context: .
        platforms: linux/amd64,linux/arm64
        push: true
        tags: ${{ steps.meta.outputs.tags }}
        labels: ${{ steps.meta.outputs.labels }}
        build-args: |
          USE_WHEEL=true
        cache-from: type=gha
        cache-to: type=gha,mode=max

    - name: Update deployment summary with production Docker info
      run: |
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### Production Docker Images" >> $GITHUB_STEP_SUMMARY
        echo '```bash' >> $GITHUB_STEP_SUMMARY
        echo "# Pull and run production Docker image" >> $GITHUB_STEP_SUMMARY
        echo "docker pull descoped/authly:${{ needs.validate-release.outputs.version }}" >> $GITHUB_STEP_SUMMARY
        echo "docker run -p 8000:8000 descoped/authly:${{ needs.validate-release.outputs.version }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "# Use latest tag" >> $GITHUB_STEP_SUMMARY
        echo "docker pull descoped/authly:latest" >> $GITHUB_STEP_SUMMARY
        echo "docker run -p 8000:8000 descoped/authly:latest" >> $GITHUB_STEP_SUMMARY
        echo '```' >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Docker Hub**: https://hub.docker.com/r/descoped/authly" >> $GITHUB_STEP_SUMMARY
        echo "**Platforms**: linux/amd64, linux/arm64" >> $GITHUB_STEP_SUMMARY

  docker-build-standalone:
    runs-on: ubuntu-latest
    needs: [validate-release, lint-and-test]
    permissions:
      contents: read
      packages: write  # For Docker registry push
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v5

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Log in to Docker Hub
      uses: docker/login-action@v3
      with:
        username: ${{ secrets.DOCKERHUB_USERNAME }}
        password: ${{ secrets.DOCKERHUB_TOKEN }}

    - name: Log in to GitHub Container Registry
      uses: docker/login-action@v3
      with:
        registry: ghcr.io
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}

    - name: Check for existing postgres-builder image
      id: check-postgres-builder
      run: |
        # PostgreSQL version tag - update this when PostgreSQL version changes
        # This should match the version in Dockerfile.standalone (line 29)
        # When updating, also increment to force a rebuild of the cached image
        PG_VERSION="17.2"
        PG_TAG="postgres-builder-${PG_VERSION}-alpine3.22"
        
        # Try to pull the postgres-builder image from GitHub packages
        # This image should be pre-built by the build-postgres-cache.yml workflow
        # using native ARM runners for optimal performance
        if docker pull ghcr.io/descoped/authly-postgres-builder:${PG_TAG} 2>/dev/null; then
          echo "âœ… Found cached postgres-builder image: ${PG_TAG}"
          echo "   (Built with native runners - no QEMU overhead!)"
          echo "exists=true" >> $GITHUB_OUTPUT
          echo "tag=${PG_TAG}" >> $GITHUB_OUTPUT
        else
          echo "âš ï¸ No pre-built postgres-builder image found: ${PG_TAG}"
          echo "   Consider running the 'Build PostgreSQL Cache' workflow first for faster builds"
          echo "   Falling back to QEMU-based build (this will be slow for ARM64)"
          echo "exists=false" >> $GITHUB_OUTPUT
          echo "tag=${PG_TAG}" >> $GITHUB_OUTPUT
        fi

    - name: Build and push postgres-builder stage if not cached
      if: steps.check-postgres-builder.outputs.exists != 'true'
      # NOTE: This fallback uses QEMU emulation for ARM64, which is slow.
      # For optimal performance, run the 'Build PostgreSQL Cache' workflow first,
      # which uses native ARM runners for 5-10x faster builds.
      uses: docker/build-push-action@v6
      with:
        context: .
        file: ./Dockerfile.standalone
        target: postgres-builder
        platforms: linux/amd64,linux/arm64
        push: true
        tags: |
          ghcr.io/descoped/authly-postgres-builder:${{ steps.check-postgres-builder.outputs.tag }}
          ghcr.io/descoped/authly-postgres-builder:latest
        cache-from: type=gha,scope=postgres-builder
        cache-to: type=gha,scope=postgres-builder,mode=max

    - name: Extract metadata for standalone image
      id: meta-standalone
      uses: docker/metadata-action@v5
      with:
        images: |
          descoped/authly-standalone
        tags: |
          type=semver,pattern={{version}},value=${{ needs.validate-release.outputs.version }}
          type=semver,pattern={{major}}.{{minor}},value=${{ needs.validate-release.outputs.version }}
          type=semver,pattern={{major}},value=${{ needs.validate-release.outputs.version }}
          type=raw,value=latest

    - name: Build and push standalone Docker image
      uses: docker/build-push-action@v6
      with:
        context: .
        file: ./Dockerfile.standalone
        platforms: linux/amd64,linux/arm64
        push: true
        tags: ${{ steps.meta-standalone.outputs.tags }}
        labels: ${{ steps.meta-standalone.outputs.labels }}
        build-args: |
          POSTGRES_BUILDER_IMAGE=ghcr.io/descoped/authly-postgres-builder:${{ steps.check-postgres-builder.outputs.tag }}
        cache-from: |
          type=gha,scope=standalone
          type=registry,ref=ghcr.io/descoped/authly-postgres-builder:${{ steps.check-postgres-builder.outputs.tag }}
        cache-to: type=gha,scope=standalone,mode=max

    - name: Update deployment summary with standalone Docker info
      run: |
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### Standalone Docker Images" >> $GITHUB_STEP_SUMMARY
        echo '```bash' >> $GITHUB_STEP_SUMMARY
        echo "# Pull and run standalone image (includes PostgreSQL + Redis)" >> $GITHUB_STEP_SUMMARY
        echo "docker pull descoped/authly-standalone:${{ needs.validate-release.outputs.version }}" >> $GITHUB_STEP_SUMMARY
        echo "docker run -it --rm -p 8000:8000 descoped/authly-standalone:${{ needs.validate-release.outputs.version }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "# Interactive shell for development" >> $GITHUB_STEP_SUMMARY
        echo "docker run -it --rm -p 8000:8000 descoped/authly-standalone:latest" >> $GITHUB_STEP_SUMMARY
        echo "authly> authly --help" >> $GITHUB_STEP_SUMMARY
        echo "authly> authly-admin --help" >> $GITHUB_STEP_SUMMARY
        echo "authly> simple-auth-flow" >> $GITHUB_STEP_SUMMARY
        echo "authly> run-end-to-end-test comprehensive" >> $GITHUB_STEP_SUMMARY
        echo '```' >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Standalone Docker Hub**: https://hub.docker.com/r/descoped/authly-standalone" >> $GITHUB_STEP_SUMMARY
        echo "**Documentation**: [Docker Deployment Guide](https://github.com/descoped/authly/blob/master/docs/docker-deployment.md)" >> $GITHUB_STEP_SUMMARY
        echo "**Features**: All-in-one container with embedded PostgreSQL, Redis, and interactive shell" >> $GITHUB_STEP_SUMMARY
        echo "**Platforms**: linux/amd64, linux/arm64" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸš€ Quick Start with Standalone" >> $GITHUB_STEP_SUMMARY
        echo '```bash' >> $GITHUB_STEP_SUMMARY
        echo "# Run with interactive shell (includes PostgreSQL + Redis)" >> $GITHUB_STEP_SUMMARY
        echo "docker run -it --rm -p 8000:8000 descoped/authly-standalone:${{ needs.validate-release.outputs.version }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "# Inside container you get:" >> $GITHUB_STEP_SUMMARY
        echo "# â€¢ authly --help                   # Main CLI" >> $GITHUB_STEP_SUMMARY
        echo "# â€¢ authly-admin --help             # Admin shortcuts (admin/admin)" >> $GITHUB_STEP_SUMMARY
        echo "# â€¢ simple-auth-flow                # Full test" >> $GITHUB_STEP_SUMMARY
        echo "# â€¢ run-end-to-end-test comprehensive  # Full tests" >> $GITHUB_STEP_SUMMARY
        echo '```' >> $GITHUB_STEP_SUMMARY